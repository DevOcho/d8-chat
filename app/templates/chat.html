{% extends "base.html" %}
{% block html_theme %}data-bs-theme="{{ theme }}"{% endblock %}
{% block layout %}
    <!-- workspaces -->
    <div class="sidebar workspace-sidebar p-2 text-center text-white">
        <!-- Workspace Logo -->
        <div class="workspace-logo mb-3">D8</div>
        <!-- user profile and status indicator -->
        <div class="profile-button-container mt-auto">
            <a href="{{ url_for('main.profile') }}" title="View your profile">
                <div class="profile-avatar">
                    <!-- User's Initial -->
                    <span>{{ (g.user.display_name or g.user.username)[0]|upper }}</span>
                    <!-- Presence Indicator Dot -->
                    {% set status_class = "presence-online" %}
                    {% if g.user.presence_status == 'away' %}
                        {% set status_class = "presence-away" %}
                    {% elif g.user.presence_status == 'busy' %}
                        {% set status_class = "presence-busy" %}
                    {% endif %}
                    <span id="sidebar-presence-indicator-{{ g.user.id }}"
                          class="presence-indicator {{ status_class }}"></span>
                </div>
            </a>
        </div>
    </div>
    <!-- channels -->
    <div class="sidebar channel-sidebar p-3">
        <h5 class="text-white">DevOcho</h5>
        <hr class="text-secondary">
        <!-- Channel list -->
        <div class="d-flex justify-content-between align-items-center">
            <h6 class="mt-4 text-secondary">Channels</h6>
            <div>
                <button class="btn btn-sm text-secondary pt-4"
                        data-bs-toggle="modal"
                        data-bs-target="#htmx-modal"
                        hx-get="{{ url_for('main.get_browse_channels_modal') }}"
                        hx-target="#htmx-modal-content"
                        title="Browse public channels">
                    <i class="bi bi-search"></i>
                </button>
                <button class="btn btn-sm text-secondary pt-4"
                        data-bs-toggle="modal"
                        data-bs-target="#htmx-modal"
                        hx-get="{{ url_for('main.get_create_channel_form') }}"
                        hx-target="#htmx-modal-content"
                        title="Create a new channel">
                    <i class="bi bi-plus-square"></i>
                </button>
            </div>
        </div>
        <!-- Button to request notification permissions -->
        <button id="enable-notifications-btn"
                class="btn btn-sm text-secondary w-100 text-start"
                style="display: none">
            <i class="bi bi-bell-fill me-1"></i> Enable Notifications
        </button>
        <ul id="channel-list" class="list-unstyled">
            {% for channel in channels %}
                {% set conv_id_str = "channel_" ~ channel.id %}
                {% set info = unread_info.get(conv_id_str, {'mentions': 0, 'has_unread': False}) %}
                <li id="channel-item-{{ channel.id }}">
                    <div class="d-flex justify-content-between align-items-center">
                        <a href="#"
                           id="link-{{ conv_id_str }}"
                           class="text-decoration-none {{ 'fw-bold text-white' if info.has_unread else 'text-secondary' }}"
                           hx-get="/chat/channel/{{ channel.id }}"
                           hx-target="#chat-messages-container"># {{ channel.name }}</a>
                        <span id="unread-badge-{{ conv_id_str }}">
                            {% if info.mentions > 0 %}<span class="badge rounded-pill bg-danger float-end">{{ info.mentions }}</span>{% endif %}
                        </span>
                    </div>
                </li>
            {% else %}
                <li id="no-channels-placeholder">No channels found.</li>
            {% endfor %}
        </ul>
        <!-- DM list -->
        <div class="d-flex justify-content-between align-items-center">
            <h6 class="mt-4 text-secondary">Direct Messages</h6>
            <button class="btn btn-sm text-secondary"
                    data-bs-toggle="modal"
                    data-bs-target="#htmx-modal"
                    hx-get="/chat/dms/start"
                    hx-target="#htmx-modal-content"
                    title="Start a new message">
                <i class="bi bi-plus-square"></i>
            </button>
        </div>
        <ul id="dm-list" class="list-unstyled">
            <!-- Current User (Self DM) -->
            {% set self_conv_id_str = "dm_" ~ g.user.id ~ "_" ~ g.user.id %}
            <li class="d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <!-- [THE FIX] This logic now correctly checks the user's own status on load -->
                    {% set self_status_class = "bg-success" %} {# Default to online #}
                    {% if g.user.presence_status == 'away' %}
                        {% set self_status_class = "bg-secondary" %}
                    {% elif g.user.presence_status == 'busy' %}
                        {% set self_status_class = "bg-warning" %}
                    {% endif %}
                    <span id="status-dot-{{ g.user.id }}"
                          class="me-2 rounded-circle {{ self_status_class }}"
                          style="width: 10px;
                                 height: 10px"></span>
                    <a href="#"
                       class="text-decoration-none text-light"
                       id="link-{{ self_conv_id_str }}"
                       hx-get="/chat/dm/{{ g.user.id }}"
                       hx-target="#chat-messages-container">{{ g.user.display_name or g.user.username }} (you)</a>
                </div>
                <span id="unread-badge-{{ self_conv_id_str }}"></span>
            </li>
            <!-- Other users -->
            {% for user in direct_message_users %}
                {% set user_ids = [g.user.id, user.id] | sort %}
                {% set conv_id_str = "dm_" ~ user_ids|join('_') %}
                {% set info = unread_info.get(conv_id_str, {'mentions': 0, 'has_unread': False}) %}
                <li>
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            {% set status_class = "bg-secondary" %} {# Default to offline (gray) #}
                            {% if online_users.get(user.id) %}
                                {% if user.presence_status == 'busy' %}
                                    {% set status_class = "bg-warning" %} {# Yellow #}
                                {% elif user.presence_status == 'away' %}
                                    {% set status_class = "bg-secondary" %} {# Gray #}
                                {% else %}
                                    {% set status_class = "bg-success" %} {# Default online is green #}
                                {% endif %}
                            {% endif %}
                            <span id="status-dot-{{ user.id }}"
                                  class="me-2 rounded-circle {{ status_class }}"
                                  style="width: 10px;
                                         height: 10px;
                                         transition: background-color 0.3s ease"></span>
                            <a href="#"
                               id="link-{{ conv_id_str }}"
                               class="text-decoration-none {{ 'fw-bold text-white' if info.has_unread else 'text-secondary' }}"
                               hx-get="/chat/dm/{{ user.id }}"
                               hx-target="#chat-messages-container">{{ user.display_name or user.username }}</a>
                        </div>
                        <span id="unread-badge-{{ conv_id_str }}">
                            {% if info.mentions > 0 %}<span class="badge rounded-pill bg-danger">{{ info.mentions }}</span>{% endif %}
                        </span>
                    </div>
                </li>
            {% endfor %}
        </ul>
    </div>
    <!-- Main content area -->
    <main class="main-content"
          ws-connect="/ws/chat"
          hx-ext="ws"
          ws-disable-replay="true"
          data-current-user-id="{{ g.user.id }}">
        <!-- Connection Status Bar -->
        <div id="connection-status-bar"
             class="p-2 bg-warning text-dark text-center"
             style="display: none;
                    flex-shrink: 0">
            <div class="spinner-border spinner-border-sm me-2" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            Connection lost. Attempting to reconnect...
        </div>
        <div id="chat-header-container"
             class="p-3 border-bottom bg-white"
             style="flex-shrink: 0">
            <!-- The header content will be swapped in from the backend -->
            <div class="text-center text-muted">
                <h4 class="mb-0">Welcome, {{ g.user.username }}!</h4>
                <p class="mb-0 small">Select a conversation to begin.</p>
            </div>
        </div>
        <!-- Scrollable Messages Container -->
        <div id="chat-messages-container"
             class="chat-messages position-relative"
             style="flex-grow: 1;
                    overflow-y: auto"
             hx-get="/chat/dm/{{ g.user.id }}"
             hx-trigger="load">
            <!-- The message list and new messages will be swapped in here -->
            <div class="text-center text-muted mt-5">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading your space...</span>
                </div>
            </div>
            <!-- "Jump to Bottom" button is now correctly associated with the messages container -->
            <button id="jump-to-bottom-btn"
                    class="btn btn-primary btn-sm rounded-pill position-absolute bottom-0 start-50 translate-middle-x mb-3"
                    style="display: none;
                           z-index: 10">
                <i class="bi bi-arrow-down"></i> Jump to Latest
            </button>
        </div>
        <!-- Message input form -->
        <div hx-get="/chat/input/default" hx-trigger="load" hx-swap="outerHTML">
            <div class="chat-input-form bg-light">
                <div class="spinner-border spinner-border-sm" role="status">
                    <span class="visually-hidden">Loading input...</span>
                </div>
            </div>
        </div>
    </main>
    <!-- Slide-Out Panel -->
    <div class="offcanvas offcanvas-end"
         tabindex="-1"
         id="right-panel-offcanvas"
         aria-labelledby="right-panel-label">
        <div class="offcanvas-header">
            <h5 id="right-panel-label">Details</h5>
            <button type="button"
                    class="btn-close"
                    data-bs-dismiss="offcanvas"
                    aria-label="Close"></button>
        </div>
        <div class="offcanvas-body" id="right-panel-body">
            <!-- Content will be loaded here by HTMX -->
            <div class="text-center">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
        </div>
    </div>
    <!-- Generic HTMX Modal -->
    <div class="modal fade"
         id="htmx-modal"
         tabindex="-1"
         aria-labelledby="htmxModalLabel"
         aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content" id="htmx-modal-content">
                <!-- Content will be loaded here by HTMX -->
                <div class="modal-body text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
{% block scripts %}
    <script type="module"
            src="https://cdn.jsdelivr.net/npm/emoji-picker-element@^1/index.js"></script>
    <script src="{{ url_for('static', filename='js/chat.js') }}" defer></script>
{% endblock %}
