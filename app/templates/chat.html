{% extends "base.html" %}

{% block layout %}
<!-- ... (sidebars are unchanged) ... -->
<div class="sidebar workspace-sidebar p-3 text-center text-white">D8</div>
<div class="sidebar channel-sidebar p-3">
    <h5 class="text-white">DevOcho</h5>
    <hr class="text-secondary">

    <!-- Channel list -->
    <div class="d-flex justify-content-between align-items-center">
        <h6 class="mt-4 text-secondary">Channels</h6>
        <button class="btn btn-sm text-secondary"
                data-bs-toggle="modal"
                data-bs-target="#createChannelModal"
                hx-get="{{ url_for('main.get_create_channel_form') }}"
                hx-target="#createChannelModalContent"
                title="Create a new channel">
            <i class="bi bi-plus-square"></i>
        </button>
    </div>
    <ul id="channel-list" class="list-unstyled">
        {% for channel in channels %}
        <li>
            <a href="#" class="text-decoration-none text-light"
               hx-get="/chat/channel/{{ channel.id }}"
               hx-target="#chat-messages-container">
                # {{ channel.name }}
            </a>
        </li>
        {% else %}
        <li>No channels found.</li>
        {% endfor %}
    </ul>

    <!-- DM list -->
    <h6 class="mt-4 text-secondary">Direct Messages</h6>
    <ul class="list-unstyled">
      <!-- Current User for talking to yourself -->
      <li class="d-flex align-items-center">
        <span id="status-dot-{{ g.user.id }}" class="me-2 rounded-circle bg-success" style="width: 10px; height: 10px;"></span>
        <a href="#" class="text-decoration-none text-light"
           hx-get="/chat/dm/{{ g.user.id }}"
           hx-target="#chat-messages-container">
            {{ g.user.username }} (you)
        </a>
      </li>
      <!-- Other users -->
      {% for user in direct_message_users %}
      <li class="d-flex align-items-center">
        <span id="status-dot-{{ user.id }}" class="me-2 rounded-circle {{ 'bg-success' if online_users.get(user.id) else 'bg-secondary' }}" style="width: 10px; height: 10px; transition: background-color 0.3s ease;"></span>
        <a href="#" class="text-decoration-none text-light"
           hx-get="/chat/dm/{{ user.id }}"
           hx-target="#chat-messages-container">
            {{ user.username }}
        </a>
      </li>
      {% endfor %}
    </ul>
</div>

<!-- Main content area -->
<main class="main-content" ws-connect="/ws/chat" hx-ext="ws">

  <div id="chat-header-container" class="p-3 border-bottom bg-white" style="flex-shrink: 0;">
      <!-- The header content will be swapped in from the backend -->
      <div class="text-center text-muted">
          <h4 class="mb-0">Welcome, {{ g.user.username }}!</h4>
          <p class="mb-0 small">Select a conversation to begin.</p>
      </div>
  </div>

  <!-- Scrollable Messages Container -->
  <div id="chat-messages-container" 
       class="chat-messages position-relative" 
       style="flex-grow: 1; overflow-y: auto;"
       hx-get="/chat/dm/{{ g.user.id }}" 
       hx-trigger="load">
      <!-- The message list and new messages will be swapped in here -->
      <div class="text-center text-muted mt-5">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading your space...</span>
        </div>
      </div>
      <!-- "Jump to Bottom" button is now correctly associated with the messages container -->
      <button id="jump-to-bottom-btn"
            class="btn btn-primary btn-sm rounded-pill position-absolute bottom-0 start-50 translate-middle-x mb-3"
            style="display: none; z-index: 10;">
      â†“ Jump to Latest
      </button>
  </div>

  <!-- Message input form (unchanged) -->
  <div class="chat-input-form bg-light">
      <!-- ... (the form and typing indicator are unchanged) ... -->
      <div id="typing-indicator" class="text-muted small" style="height: 20px;"></div>
      <form ws-send id="message-form" autocomplete="off">
          <div class="input-group">
              <input id="chat-message-input" name="chat_message" class="form-control" placeholder="Type a message..." autofocus>
              <button type="submit" class="btn btn-primary">Send</button>
          </div>
      </form>
      <div id="typing-sender" ws-send hx-trigger="typing-event" style="display: none;"></div>
  </div>
</main>

<!-- Bootstrap Modal to add channels -->
<div class="modal fade" id="createChannelModal" tabindex="-1" aria-labelledby="createChannelModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content" id="createChannelModalContent">
      <!-- The form partial from /chat/channels/create will be loaded here by HTMX -->
      <div class="modal-body text-center">
          <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- Configuration ---
    const doneTypingInterval = 1500; // ms
    const scrollThreshold = 150;     // Pixels from bottom

    // --- Element References ---
    // This one was updated in our last change
    const messagesContainer = document.getElementById('chat-messages-container'); 
    
    // These were here before and are still needed
    const jumpToBottomBtn = document.getElementById('jump-to-bottom-btn');
    const messageInput = document.getElementById('chat-message-input');
    const messageForm = document.getElementById('message-form');
    const typingSender = document.getElementById('typing-sender');
    let typingTimer;

    // --- Local Vars ---
    let shouldScrollOnNextMessage = false;

    // --- Helper Functions ---
    const isUserNearBottom = () => {
        const scrollableHeight = messagesContainer.scrollHeight - messagesContainer.clientHeight;
        return scrollableHeight - messagesContainer.scrollTop < scrollThreshold;
    };

    const scrollToBottom = () => {
        setTimeout(() => {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }, 50);
    };

    const scrollLastMessageIntoView = () => {
        const messageList = document.getElementById('message-list');
        if (messageList) {
            const lastMessage = messageList.lastElementChild;
            if (lastMessage) {
                lastMessage.scrollIntoView({ behavior: "smooth", block: "nearest" });
            }
        }
    };

    // --- HTMX Event Listeners (All logic combined) ---

    // For scrolling correctly when loading history (GET request)
    document.body.addEventListener('htmx:afterSwap', (event) => {
        const target = event.detail.target;

        // Check if we just loaded new chat history via a GET request
        if (target.id === 'chat-messages-container' && event.detail.requestConfig.verb === 'get') {
            scrollLastMessageIntoView();
            jumpToBottomBtn.style.display = 'none';

            // Set focus to the chat input so the user can type immediately.
            messageInput.focus(); 
        }
    });

    // For scrolling correctly on incoming WebSocket messages
    document.body.addEventListener('htmx:wsBeforeMessage', (event) => {
        // We attach our decision to the event object to pass it to the next listener.
        shouldScrollOnNextMessage = isUserNearBottom();
    });

    document.body.addEventListener('htmx:wsAfterMessage', (event) => {
        // We check for the flag we set in the `wsBeforeMessage` event.
        if (shouldScrollOnNextMessage) {
            scrollLastMessageIntoView();
        } else {
            jumpToBottomBtn.style.display = 'block';
        }
    });

    // --- THIS IS THE RESTORED SECTION ---
    // Fired after the main message form sends data over the WebSocket.
    messageForm.addEventListener('htmx:wsAfterSend', () => {
        // This correctly clears the form's input field.
        messageForm.reset();
        messageInput.focus();
    });
    // --- END RESTORED SECTION ---


    // --- Standard Browser Event Listeners for UI (Unchanged) ---
    messagesContainer.addEventListener('scroll', () => {
        if (isUserNearBottom()) {
            jumpToBottomBtn.style.display = 'none';
        }
    });

    jumpToBottomBtn.addEventListener('click', () => {
        scrollToBottom();
        jumpToBottomBtn.style.display = 'none';
    });

    // --- Typing Indicator Logic (Unchanged) ---
    const sendTypingStatus = (isTyping) => {
        const activeConversation = document.querySelector('#chat-messages-container > div[data-conversation-id]');
        if (activeConversation) {
            const conversationId = activeConversation.dataset.conversationId;
            const payload = {
                type: isTyping ? 'typing_start' : 'typing_stop',
                conversation_id: conversationId
            };
            typingSender.setAttribute('hx-vals', JSON.stringify(payload));
            htmx.trigger(typingSender, 'typing-event');
        }
    };

    messageInput.addEventListener('input', () => {
        clearTimeout(typingTimer);
        sendTypingStatus(true);
        typingTimer = setTimeout(() => sendTypingStatus(false), doneTypingInterval);
    });

    messageForm.addEventListener('submit', () => {
        clearTimeout(typingTimer);
        sendTypingStatus(false);
    });

    // --- Logic to handle the create channel modal ---
    const createChannelModalEl = document.getElementById('createChannelModal');
    const createChannelModal = new bootstrap.Modal(createChannelModalEl);

    // Listen for the custom event triggered by the HX-Trigger header
    document.body.addEventListener('close-create-channel-modal', () => {
        createChannelModal.hide();
    });

    // Reset the modal content when it's hidden to ensure the form is fresh next time
    createChannelModalEl.addEventListener('hidden.bs.modal', function () {
        document.getElementById('createChannelModalContent').innerHTML = `
            <div class="modal-body text-center">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>`;
    });

});
</script>
{% endblock %}
