{% extends "base.html" %}

{% block layout %}
<!-- ... (sidebars are unchanged) ... -->
<div class="sidebar workspace-sidebar p-3 text-center text-white">D8</div>
<div class="sidebar channel-sidebar p-3">
    <h5 class="text-white">DevOcho</h5>
    <hr class="text-secondary">

    <!-- Channel list -->
    <div class="d-flex justify-content-between align-items-center">
        <h6 class="mt-4 text-secondary">Channels</h6>
        <button class="btn btn-sm text-secondary pt-4"
                data-bs-toggle="modal"
                data-bs-target="#htmx-modal"
                hx-get="{{ url_for('main.get_create_channel_form') }}"
                hx-target="#htmx-modal-content"
                title="Create a new channel">
            <i class="bi bi-plus-square"></i>
        </button>
    </div>
    <ul id="channel-list" class="list-unstyled">
        {% for channel in channels %}
        {% set conv_id_str = "channel_" ~ channel.id %}
        {% set count = unread_counts.get(conv_id_str, 0) %}
        <li>
          <div class="d-flex justify-content-between align-items-center">
            <a href="#" id="link-{{ conv_id_str }}" class="text-decoration-none {{ 'fw-bold text-white' if count > 0 else 'text-light' }}"
               hx-get="/chat/channel/{{ channel.id }}"
               hx-target="#chat-messages-container">
                # {{ channel.name }}
            </a>
            <span id="unread-badge-{{ conv_id_str }}">
              {% if count > 0 %}
              <span class="badge rounded-pill bg-danger float-end">{{ count }}</span>
              {% endif %}
            </span>
          </div>
        </li>
        {% else %}
        <li>No channels found.</li>
        {% endfor %}
    </ul>

    <!-- DM list -->
    <div class="d-flex justify-content-between align-items-center">
        <h6 class="mt-4 text-secondary">Direct Messages</h6>
        <button class="btn btn-sm text-secondary"
                data-bs-toggle="modal"
                data-bs-target="#htmx-modal"
                hx-get="/chat/dms/start"
                hx-target="#htmx-modal-content"
                title="Start a new message">
            <i class="bi bi-plus-square"></i>
        </button>
    </div>
    <ul id="dm-list" class="list-unstyled">
      <!-- Current User for talking to yourself -->
      <li class="d-flex align-items-center">
        <span id="status-dot-{{ g.user.id }}" class="me-2 rounded-circle bg-success" style="width: 10px; height: 10px;"></span>
        <a href="#" class="text-decoration-none text-light"
           hx-get="/chat/dm/{{ g.user.id }}"
           hx-target="#chat-messages-container">
            {{ g.user.username }} (you)
        </a>
      </li>
      <!-- Other users -->
      {% for user in direct_message_users %}
      {% set user_ids = [g.user.id, user.id] | sort %}
      {% set conv_id_str = "dm_" ~ user_ids|join('_') %}
      {% set count = unread_counts.get(conv_id, 0) %}
      <li>
        <div class="d-flex justify-content-between align-items-center">
          <div class="d-flex align-items-center">
            <span id="status-dot-{{ user.id }}" class="me-2 rounded-circle {{ 'bg-success' if online_users.get(user.id) else 'bg-secondary' }}" style="width: 10px; height: 10px; transition: background-color 0.3s ease;"></span>
            <a href="#" id="link-{{ conv_id_str }}" class="text-decoration-none {{ 'fw-bold text-white' if count > 0 else 'text-light' }}"
               hx-get="/chat/dm/{{ user.id }}"
               hx-target="#chat-messages-container">
                {{ user.username }}
            </a>
          </div>
          <span id="unread-badge-{{ conv_id_str }}">
            {% if count > 0 %}
            <span class="badge rounded-pill bg-danger">{{ count }}</span>
            {% endif %}
          </span>
        </div>
      </li>
      {% endfor %}
    </ul>
</div>

<!-- Main content area -->
<main class="main-content" ws-connect="/ws/chat" hx-ext="ws" data-current-user-id="{{ g.user.id }}">

  <div id="chat-header-container" class="p-3 border-bottom bg-white" style="flex-shrink: 0;">
      <!-- The header content will be swapped in from the backend -->
      <div class="text-center text-muted">
          <h4 class="mb-0">Welcome, {{ g.user.username }}!</h4>
          <p class="mb-0 small">Select a conversation to begin.</p>
      </div>
  </div>

  <!-- Scrollable Messages Container -->
  <div id="chat-messages-container" 
       class="chat-messages position-relative" 
       style="flex-grow: 1; overflow-y: auto;"
       hx-get="/chat/dm/{{ g.user.id }}" 
       hx-trigger="load">
      <!-- The message list and new messages will be swapped in here -->
      <div class="text-center text-muted mt-5">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading your space...</span>
        </div>
      </div>
      <!-- "Jump to Bottom" button is now correctly associated with the messages container -->
      <button id="jump-to-bottom-btn"
            class="btn btn-primary btn-sm rounded-pill position-absolute bottom-0 start-50 translate-middle-x mb-3"
            style="display: none; z-index: 10;">
      â†“ Jump to Latest
      </button>
  </div>

  <!-- Message input form -->
  <div hx-get="/chat/input/default" hx-trigger="load" hx-swap="outerHTML">
      <div class="chat-input-form bg-light">
          <div class="spinner-border spinner-border-sm" role="status">
              <span class="visually-hidden">Loading input...</span>
          </div>
      </div>
  </div>
</main>

<!-- Generic HTMX Modal -->
<div class="modal fade" id="htmx-modal" tabindex="-1" aria-labelledby="htmxModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content" id="htmx-modal-content">
      <!-- Content will be loaded here by HTMX -->
      <div class="modal-body text-center">
          <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
    <script src="{{ url_for('static', filename='js/chat.js') }}" defer></script>
{% endblock %}
