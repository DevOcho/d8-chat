{% extends "base.html" %}

{% block layout %}
<!-- ... (sidebars are unchanged) ... -->
<div class="sidebar workspace-sidebar p-3 text-center text-white">D8</div>
<div class="sidebar channel-sidebar p-3">
    <h5 class="text-white">DevOcho</h5>
    <hr class="text-secondary">

    <!-- Channel list -->
    <div class="d-flex justify-content-between align-items-center">
        <h6 class="mt-4 text-secondary">Channels</h6>
        <button class="btn btn-sm text-secondary"
                data-bs-toggle="modal"
                data-bs-target="#createChannelModal"
                hx-get="{{ url_for('main.get_create_channel_form') }}"
                hx-target="#createChannelModalContent"
                title="Create a new channel">
            <i class="bi bi-plus-square"></i>
        </button>
    </div>
    <ul id="channel-list" class="list-unstyled">
        {% for channel in channels %}
        <li>
            <a href="#" class="text-decoration-none text-light"
               hx-get="/chat/channel/{{ channel.id }}"
               hx-target="#chat-messages-container">
                # {{ channel.name }}
            </a>
        </li>
        {% else %}
        <li>No channels found.</li>
        {% endfor %}
    </ul>

    <!-- DM list -->
    <h6 class="mt-4 text-secondary">Direct Messages</h6>
    <ul class="list-unstyled">
      <!-- Current User for talking to yourself -->
      <li class="d-flex align-items-center">
        <span id="status-dot-{{ g.user.id }}" class="me-2 rounded-circle bg-success" style="width: 10px; height: 10px;"></span>
        <a href="#" class="text-decoration-none text-light"
           hx-get="/chat/dm/{{ g.user.id }}"
           hx-target="#chat-messages-container">
            {{ g.user.username }} (you)
        </a>
      </li>
      <!-- Other users -->
      {% for user in direct_message_users %}
      <li class="d-flex align-items-center">
        <span id="status-dot-{{ user.id }}" class="me-2 rounded-circle {{ 'bg-success' if online_users.get(user.id) else 'bg-secondary' }}" style="width: 10px; height: 10px; transition: background-color 0.3s ease;"></span>
        <a href="#" class="text-decoration-none text-light"
           hx-get="/chat/dm/{{ user.id }}"
           hx-target="#chat-messages-container">
            {{ user.username }}
        </a>
      </li>
      {% endfor %}
    </ul>
</div>

<!-- Main content area -->
<main class="main-content" ws-connect="/ws/chat" hx-ext="ws">

  <div id="chat-header-container" class="p-3 border-bottom bg-white" style="flex-shrink: 0;">
      <!-- The header content will be swapped in from the backend -->
      <div class="text-center text-muted">
          <h4 class="mb-0">Welcome, {{ g.user.username }}!</h4>
          <p class="mb-0 small">Select a conversation to begin.</p>
      </div>
  </div>

  <!-- Scrollable Messages Container -->
  <div id="chat-messages-container" 
       class="chat-messages position-relative" 
       style="flex-grow: 1; overflow-y: auto;"
       hx-get="/chat/dm/{{ g.user.id }}" 
       hx-trigger="load">
      <!-- The message list and new messages will be swapped in here -->
      <div class="text-center text-muted mt-5">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading your space...</span>
        </div>
      </div>
      <!-- "Jump to Bottom" button is now correctly associated with the messages container -->
      <button id="jump-to-bottom-btn"
            class="btn btn-primary btn-sm rounded-pill position-absolute bottom-0 start-50 translate-middle-x mb-3"
            style="display: none; z-index: 10;">
      â†“ Jump to Latest
      </button>
  </div>

  <!-- Message input form -->
  <div hx-get="/chat/input/default" hx-trigger="load" hx-swap="outerHTML">
      <div class="chat-input-form bg-light">
          <div class="spinner-border spinner-border-sm" role="status">
              <span class="visually-hidden">Loading input...</span>
          </div>
      </div>
  </div>
</main>

<!-- Bootstrap Modal to add channels -->
<div class="modal fade" id="createChannelModal" tabindex="-1" aria-labelledby="createChannelModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content" id="createChannelModalContent">
      <!-- The form partial from /chat/channels/create will be loaded here by HTMX -->
      <div class="modal-body text-center">
          <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- Configuration ---
    const scrollThreshold = 150;     // Pixels from bottom

    // --- Element References ---
    const messagesContainer = document.getElementById('chat-messages-container');
    const jumpToBottomBtn = document.getElementById('jump-to-bottom-btn');
    const messageInput = document.getElementById('chat-message-input'); // This will now be null initially, which is fine.

    // --- Local Vars ---
    let shouldScrollOnNextMessage = false;

    // --- Helper Functions ---
    const isUserNearBottom = () => {
        const scrollableHeight = messagesContainer.scrollHeight - messagesContainer.clientHeight;
        return scrollableHeight - messagesContainer.scrollTop < scrollThreshold;
    };

    const scrollToBottom = () => {
        setTimeout(() => {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }, 50);
    };

    const scrollLastMessageIntoView = () => {
        const messageList = document.getElementById('message-list');
        if (messageList) {
            const lastMessage = messageList.lastElementChild;
            if (lastMessage) {
                lastMessage.scrollIntoView({ behavior: "smooth", block: "nearest" });
            }
        }
    };

    // --- HTMX Event Listeners (All logic combined) ---

    // For scrolling correctly when loading history (GET request)
    document.body.addEventListener('htmx:afterSwap', (event) => {
        const target = event.detail.target;

        // Process code blocks for ANY new content swapped in
        processCodeBlocks(target);

        if (target.id === 'chat-messages-container' && event.detail.requestConfig.verb === 'get') {
            scrollLastMessageIntoView();
            jumpToBottomBtn.style.display = 'none';

            // We need to focus the new input, which might have just been swapped in
            const newMmessageInput = document.getElementById('chat-message-input');
            if (newMmessageInput) {
                newMmessageInput.focus();
            }
        }
    });

    // For scrolling correctly on incoming WebSocket messages
    document.body.addEventListener('htmx:wsBeforeMessage', (event) => {
        shouldScrollOnNextMessage = isUserNearBottom();
    });

    document.body.addEventListener('htmx:wsAfterMessage', (event) => {
        const messageList = document.getElementById('message-list');
        if (messageList && messageList.lastElementChild) {
            // I don't love this but AI suggested it
            setTimeout(() => { processCodeBlocks(messageList.lastElementChild); }, 50);
        }

        if (shouldScrollOnNextMessage) {
            scrollLastMessageIntoView();
        } else {
            jumpToBottomBtn.style.display = 'block';
        }
    });

    // --- Standard Browser Event Listeners for UI (Unchanged) ---
    messagesContainer.addEventListener('scroll', () => {
        if (isUserNearBottom()) {
            jumpToBottomBtn.style.display = 'none';
        }
    });

    jumpToBottomBtn.addEventListener('click', () => {
        scrollToBottom();
        jumpToBottomBtn.style.display = 'none';
    });

    // --- Logic to handle the create channel modal ---
    const createChannelModalEl = document.getElementById('createChannelModal');
    const createChannelModal = new bootstrap.Modal(createChannelModalEl);

    document.body.addEventListener('close-create-channel-modal', () => {
        createChannelModal.hide();
    });

    createChannelModalEl.addEventListener('hidden.bs.modal', function () {
        document.getElementById('createChannelModalContent').innerHTML = `
            <div class="modal-body text-center">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>`;
    });

const processCodeBlocks = (container) => {
        const MAX_HEIGHT = 300; // Max height in pixels before collapsing
        const codeBlocks = container.querySelectorAll('.codehilite:not(.code-processed)');

        codeBlocks.forEach(block => {
            // Check if the content is taller than our max height
            if (block.scrollHeight > MAX_HEIGHT) {
                // Start the block in its collapsed state
                block.classList.add('collapsible');

                // Create the persistent toggler button
                const toggler = document.createElement('div');
                toggler.className = 'code-expander'; // We can reuse the existing style
                toggler.innerText = 'Show more...';
                block.appendChild(toggler);

                // Add a permanent click event listener to the toggler
                toggler.addEventListener('click', () => {
                    // Toggle the class that controls the height
                    block.classList.toggle('collapsible');

                    // Update the button text based on the new state
                    if (block.classList.contains('collapsible')) {
                        toggler.innerText = 'Show more...';
                    } else {
                        toggler.innerText = 'Show less';
                    }
                });
            }
            // Mark the block as processed so we don't add multiple buttons
            block.classList.add('code-processed');
        });
    };

    // Run once on initial load for the first batch of messages
    processCodeBlocks(document.body);

});
</script>
{% endblock %}
