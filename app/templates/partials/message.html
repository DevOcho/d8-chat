<div class="d-flex mb-3 message-container" id="message-{{ message.id }}" data-user-id="{{ message.user.id }}">
    <div class="flex-shrink-0">
        <div class="rounded-circle bg-secondary text-white d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
            {{ message.user.username[0]|upper }}
        </div>
    </div>
    <div class="flex-grow-1 ms-3">
        <div>
            <strong class="me-2">{{ message.user.username }}</strong>
            <small class="text-muted">{{ message.created_at.strftime('%I:%M %p') }}</small>
            {% if message.is_edited %}<small class="text-muted">(edited)</small>{% endif %}
        </div>

        {# --- THIS IS THE NEW REPLY LOGIC --- #}
        {% if message.parent_message %}
            <div class="quoted-reply p-2 mb-2">
                <strong>{{ message.parent_message.user.username }}</strong>
                {# Truncate the original message to avoid long quotes #}
                <p class="mb-0 text-muted">{{ message.parent_message.content | truncate(100) }}</p>
            </div>
        {% endif %}

        <div class="message-content" style="white-space: pre-wrap; overflow-x: auto;">{{ message.content | markdown }}</div>
    </div>
    {% if g.user and g.user.id == message.user.id %}
        {% include 'partials/message_toolbar.html' %}
    {% endif %}
</div>
