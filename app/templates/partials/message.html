{# Add the 'mentioned-message' class if this message ID is in our set #}
<div class="d-flex mb-1 message-container {% if message.id in mention_message_ids %}mentioned-message{% endif %}"
     id="message-{{ message.id }}"
     data-user-id="{{ message.user.id }}">
    <div class="flex-shrink-0">
        {% with user=message.user, size=40 %}
            {% include 'partials/_avatar_display.html' %}
        {% endwith %}
    </div>
    <div class="flex-grow-1 ms-3">
        <div>
            <strong class="me-2">{{ message.user.display_name or message.user.username }}</strong>
            <small class="text-muted">{{ message.created_at.strftime("%I:%M %p") }}</small>
            {% if message.is_edited %}<small class="text-muted">(edited)</small>{% endif %}
        </div>
        {% if message.parent_message %}
            <div class="quoted-reply p-2 mb-2">
                <strong>{{ message.parent_message.user.display_name or message.parent_message.user.username }}</strong>
                {# Truncate the original message to avoid long quotes #}
                <p class="mb-0 text-muted">{{ message.parent_message.content | emojize | truncate(100) }}</p>
            </div>
        {% endif %}
        <div class="message-content" style="overflow-x: auto;">{{ message.content | markdown }}</div>
        {% if message.attachment and message.attachment.mime_type.startswith('image/') %}
            <div class="mt-2">
                <a href="{{ message.attachment_url }}"
                   target="_blank"
                   title="View full image">
                    <img src="{{ message.attachment_url }}"
                         alt="User attachment: {{ message.attachment.original_filename }}"
                         style="max-width: 300px;
                                max-height: 200px;
                                border-radius: 8px">
                </a>
            </div>
        {% endif %}
        <div id="reactions-container-{{ message.id }}"
             class="mt-1 d-flex flex-wrap gap-1">
            {# Check if there are reactions for this message in the map from the server #}
            {% if reactions_map and message.id in reactions_map %}
                {# If so, render them using the same partial the websocket uses #}
                {% set grouped_reactions = reactions_map[message.id] %}
                {% include 'partials/reactions.html' %}
            {% endif %}
        </div>
    </div>
    {% if g.user %}
        {% include 'partials/message_toolbar.html' %}
    {% endif %}
</div>
