<div class="message-toolbar">
    <button class="btn btn-sm btn-light"
            data-bs-toggle="popover"
            data-message-id="{{ message.id }}"
            title="Add Reaction">
        <i class="bi bi-emoji-smile"></i>
    </button>
    {% if not is_in_thread_view %}
        {# This is the "Quote Reply" button. It's always available. #}
        <button class="btn btn-sm btn-light"
                hx-get="/chat/message/{{ message.id }}/reply"
                hx-target="#chat-input-container"
                hx-swap="outerHTML"
                data-action="reply"
                title="Quote Reply">
            <i class="bi bi-reply-fill"></i>
        </button>
        {# This is the "Reply in Thread" button. It ONLY appears in channels. #}
        {% if message.conversation.type == 'channel' %}
            <button class="btn btn-sm btn-light"
                    hx-get="{{ url_for('main.view_thread', parent_message_id=message.id) }}"
                    hx-target="#right-panel-offcanvas"
                    data-action="view-thread"
                    title="Reply in Thread">
                {# Using a different icon to distinguish from quote reply #}
                <i class="bi bi-chat-square-text-fill"></i>
            </button>
        {% endif %}
    {% endif %}
    {% if g.user.id == message.user.id %}
        {% if is_in_thread_view %}
            {# When in a thread, target the thread's input container #}
            <button class="btn btn-sm btn-light"
                    hx-get="/chat/message/{{ message.id }}/load_for_thread_edit"
                    hx-target="#thread-input-container-{{ message.parent_message.id }}"
                    hx-swap="outerHTML"
                    data-action="edit"
                    title="Edit">
                <i class="bi bi-pencil-square"></i>
            </button>
        {% else %}
            {# When in the main view, target the main chat input container #}
            <button class="btn btn-sm btn-light"
                    hx-get="/chat/message/{{ message.id }}/load_for_edit"
                    hx-target="#chat-input-container"
                    hx-swap="outerHTML"
                    data-action="edit"
                    title="Edit">
                <i class="bi bi-pencil-square"></i>
            </button>
        {% endif %}
        <button class="btn btn-sm btn-light"
                hx-delete="/chat/message/{{ message.id }}"
                hx-target="#message-{{ message.id }}"
                hx-swap="outerHTML"
                hx-confirm="Are you sure you want to delete this message?"
                data-action="delete"
                title="Delete">
            <i class="bi bi-trash"></i>
        </button>
    {% endif %}
</div>
