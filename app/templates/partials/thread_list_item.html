{% set channel = channel_map.get(message.conversation.conversation_id_str.split('_')[1]|int) if message.conversation.type == 'channel' else None %}
<div class="d-flex p-3 border-bottom text-decoration-none text-body"
     style="cursor: pointer"
     hx-get="{{ url_for('messages.view_thread', parent_message_id=message.id) }}"
     hx-target="#right-panel-offcanvas">
    <div class="flex-shrink-0">
        {% with user=message.user, size=40 %}
            {% include 'partials/_avatar_display.html' %}
        {% endwith %}
    </div>
    <div class="flex-grow-1 ms-3">
        <div>
            <strong class="me-2">{{ message.user.display_name or message.user.username }}</strong>
            <small class="text-muted">{{ message.created_at.strftime("%I:%M %p") }}</small>
            {% if channel %}<span class="text-muted small">in #{{ channel.name }}</span>{% endif %}
        </div>
        <div class="message-content text-muted" style="font-size: 0.9rem;">
            {{ message.content | emojize | truncate(150) }}
        </div>
        {# Thread reply indicator #}
        {% set threaded_replies = message.replies.where(Message.reply_type == 'thread') %}
        {% set thread_reply_count = threaded_replies.count() %}
        {% if thread_reply_count > 0 %}
            <div class="d-flex align-items-center mt-2">
                <div class="thread-participant-avatars">
                    {% for participant in message.thread_participants %}
                        <div class="thread-participant-avatar">
                            {% with user=participant, size=24 %}
                                {% include 'partials/_avatar_display.html' %}
                            {% endwith %}
                        </div>
                    {% endfor %}
                </div>
                <span class="text-decoration-none small ms-2 text-primary">
                    {{ thread_reply_count }} {{ 'reply' if thread_reply_count == 1 else 'replies' }}
                </span>
                <span class="text-muted small ms-2">
                    Last reply {{ message.last_reply_at.strftime("%b %d") if message.last_reply_at else '' }}
                </span>
            </div>
        {% endif %}
    </div>
</div>
