document.addEventListener('DOMContentLoaded', () => {
    // --- Configuration ---
    const scrollThreshold = 150;     // Pixels from bottom

    // --- Element References ---
    const messagesContainer = document.getElementById('chat-messages-container');
    const jumpToBottomBtn = document.getElementById('jump-to-bottom-btn');
    // Get the current user's ID from the data attribute on the <main> tag
    const mainContent = document.querySelector('main.main-content');
    const currentUserId = mainContent.dataset.currentUserId;


    // --- Helper Functions ---
    const isUserNearBottom = () => {
        const scrollableHeight = messagesContainer.scrollHeight - messagesContainer.clientHeight;
        return scrollableHeight - messagesContainer.scrollTop < scrollThreshold;
    };

    const scrollToBottom = () => {
        setTimeout(() => {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }, 50);
    };

    const scrollLastMessageIntoView = () => {
        const messageList = document.getElementById('message-list');
        if (messageList && messageList.lastElementChild) {
            messageList.lastElementChild.scrollIntoView({ behavior: "smooth", block: "nearest" });
        }
    };

    const processCodeBlocks = (container) => {
        const MAX_HEIGHT = 300;
        const codeBlocks = container.querySelectorAll('.codehilite:not(.code-processed)');
        codeBlocks.forEach(block => {
            if (block.scrollHeight > MAX_HEIGHT) {
                block.classList.add('collapsible');
                const toggler = document.createElement('div');
                toggler.className = 'code-expander';
                toggler.innerText = 'Show more...';
                block.appendChild(toggler);
                toggler.addEventListener('click', () => {
                    block.classList.toggle('collapsible');
                    toggler.innerText = block.classList.contains('collapsible') ? 'Show more...' : 'Show less';
                });
            }
            block.classList.add('code-processed');
        });
    };

    // --- HTMX Event Listeners ---
    document.body.addEventListener('htmx:afterSwap', (event) => {
        const target = event.detail.target;
        processCodeBlocks(target);

        if (target.id === 'chat-messages-container' && event.detail.requestConfig.verb === 'get') {
            scrollLastMessageIntoView();
            jumpToBottomBtn.style.display = 'none';
            const newMmessageInput = document.getElementById('chat-message-input');
            if (newMmessageInput) newMmessageInput.focus();
        }
    });

    document.body.addEventListener('htmx:wsAfterMessage', (event) => {
        const messageList = document.getElementById('message-list');
        if (messageList && messageList.lastElementChild) {
            setTimeout(() => processCodeBlocks(messageList.lastElementChild), 50);
        }

        if (isUserNearBottom()) {
            scrollLastMessageIntoView();
        } else {
            jumpToBottomBtn.style.display = 'block';
        }
    });

    // --- Standard Browser Event Listeners ---
    messagesContainer.addEventListener('scroll', () => {
        if (isUserNearBottom()) {
            jumpToBottomBtn.style.display = 'none';
        }
    });

    jumpToBottomBtn.addEventListener('click', () => {
        scrollToBottom();
        jumpToBottomBtn.style.display = 'none';
    });

    // --- Logic to handle the create channel modal ---
    const createChannelModalEl = document.getElementById('createChannelModal');
    if (createChannelModalEl) {
        const createChannelModal = new bootstrap.Modal(createChannelModalEl);
        document.body.addEventListener('close-create-channel-modal', () => createChannelModal.hide());
        createChannelModalEl.addEventListener('hidden.bs.modal', function () {
            document.getElementById('createChannelModalContent').innerHTML = `
                <div class="modal-body text-center">
                    <div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div>
                </div>`;
        });
    }

    // Run once on initial load for the first batch of messages
    processCodeBlocks(document.body);
});
